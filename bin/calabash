#!/usr/bin/env ruby
# TODO: Remove this
$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require 'calabash'
require 'calabash/android'
require 'calabash/ios'

module Calabash
  module CLI
    require 'calabash/cli'

    class CLI
      include Calabash::CLI::Helpers
      include Calabash::CLI::Build

      def initialize(arguments)
        @arguments = arguments.dup
        @original_arguments = @arguments.dup
        @options = {verbose: false, platform: nil}
      end

      def evaluate
        parse_arguments!
      end

      private

      def parse_arguments!
        argument = @arguments.shift

        case argument
          when '-v', '--verbose'
            @options[:verbose] = true
            Logger.log_levels += [:debug]
            parse_arguments!
          when '--platform'
            platform = @arguments.shift.downcase

            fail("Invalid specified platform '#{platform}'") unless platform == 'android' || platform == 'ios'

            @options[:platform] = platform.to_s

            parse_arguments!
          when 'build'
            parse_build_arguments!
          when nil
            fail("Invalid command #{@original_arguments.join(' ')}", true)
          else
            fail("Invalid argument #{argument}")
        end
      end
    end
  end
end

Calabash::CLI::CLI.new(ARGV).evaluate
